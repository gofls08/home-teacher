<script lang="ts">
	import { createEventDispatcher, onMount } from "svelte";
	import {
		S3Client,
		AbortMultipartUploadCommand,
		GetObjectCommand,
	} from "@aws-sdk/client-s3";
	import type { iPost, iChat } from "$lib/type";
	const dispatch = createEventDispatcher();
	const albumBucketName = "project0884";
	const bucketRegion = "ap-northeast-2";
	import {
		Modal,
		Button,
		Textarea,
		Toolbar,
		ToolbarGroup,
		ToolbarButton,
		SpeedDial,
		Avatar,
		Card,
		Search
	} from "flowbite-svelte";

	import { getAuth } from "firebase/auth";

	const auth = getAuth();

	const curUser = auth.currentUser;
	let displayName = " ";
	if (curUser !== null) {
		curUser.providerData.forEach((profile) => {
			if (profile.displayName !== null) {
				displayName = profile.displayName;
			}
		});
	}

	let chat = "";
	

	let con = false;

	function content() {
		con = true;
	}
	function x() {
		con = false;
	}

	let title = "";
	let body = "";

	let chatting: iChat[] = [];
	let postting: iPost[] = [];

	onMount(async () => {
		const group = "group1";
		const chat = await fetch(`/api/chat?group=${group}`);
		chatting = await chat.json();
		const post = await fetch(`/api/post?group=${group}`);
		postting = await post.json();
		// posts = await post.json();
		// console.log(await pro.Body.)
	});

	let search="";
	function reload() {
		window.location.reload();
	}

	let files: FileList;
	let src = "";
	$: {
		if (files?.[0]) {
			let t = files[0];
			fetch(`/community/img?name=${t.name}`, {
				method: "POST",
				body: t,
			}).then((v) => v.text());
			// .then(v => console.log(v));
			URL.revokeObjectURL(src);
			src = URL.createObjectURL(t);
		}
	}
	let a="";
	function find(){
		search=a;
	}
	let num=0;
</script>

<body>
	<form class="flex gap-2">
			<Search size="md"  bind:value={a}/>
			<Button class="!p-2.5" on:click={find}>
				<svg
					class="w-5 h-5"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
					xmlns="http://www.w3.org/2000/svg"
					><path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
					/></svg
				>
			</Button>
		</form>
	<div style="display:flex; margin:20px;">
		
		<div class="group">
			{#each postting as post}
			{#if post.body.includes(search)  || post.title.includes(search)}
				<div
					style="width: 300px; height:200px;display:inline-block;margin-left:30px;"
				>
					<Card
						href="/post/{post._id}"
						img="https://img.sbs.co.kr/newimg/news/20181126/201253735_1280.jpg"
					>
						<h5
							class=" text-xl font-bold tracking-tight text-gray-900 dark:text-white"
						>
							{post.title.slice(0, 15)}...
						</h5>
						<p
							class=" font-normal text-gray-700 dark:text-gray-400 leading-tight"
						>
							{post.body.slice(0, 20)}...
						</p>
					</Card>
				</div>
			{/if}
				
			{/each}
		</div>
		{#if curUser}
			<div
				class="message"
				style="width:30%;mergin-left:20px; background-color:white;"
			>
				<div class="chat_wrap">
					<div class="header">CHAT</div>
					<div class="chat">
						<ul>
							{#each chatting as json, i}
								{#if i >= chatting.length - 10}
									<li
										class={displayName === json.user
											? "right"
											: "left"}
									>
										{#if displayName === json.user}
											<div class="message">
												{json.chat}
											</div>
											<span class="profile"
												>{json.user.charAt(0)}</span
											>
										{:else}
											<span class="profile"
												>{json.user.charAt(0)}</span
											>
											<div class="message">
												{json.chat}
											</div>
										{/if}
									</li>
								{/if}
							{/each}
						</ul>
					</div>
					<div class="input-div">
						<textarea
							bind:value={chat}
							on:keypress={async (e) => {
								if (e.code === "Enter" && !e.shiftKey) {
									const description = {
										user: displayName,
										chat,
										date: new Date(),
										group: "group1",
									};

									const response = await fetch(
										"/api/chat/upload",
										{
											method: "POST",
											body: JSON.stringify({
												description,
											}),
											headers: {
												"Content-Type":
													"application/json",
											},
										}
									);

									// Array(displayName, chat, new Date());

									await response.json();
									chatting = [
										...chatting,
										{
											user: displayName,
											chat,
											date: new Date(),
											group: "group1",
										},
									];
									chat = "";
									reload();
									e.preventDefault();
								}
							}}
							placeholder="Press Enter for send message."
						/>
					</div>
				</div>
			</div>
		{/if}
	</div>

	<div on:click={content}>
		<SpeedDial
			defaultClass="absolute left-18 bottom-6"
			color="purple"
			tooltip="none"
			style="background-color:rgb(132, 132, 216);"
		>
			<svg
				slot="icon"
				aria-hidden="true"
				class="w-8 h-8"
				fill="currentColor"
				viewBox="0 0 20 20"
				xmlns="http://www.w3.org/2000/svg"
				><path
					d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
				/></svg
			>
		</SpeedDial>
	</div>

	<Modal title="Add to Content" bind:open={con} autoclose>
		<label for="editor" class="sr-only">Publish post</label>
		<input type="text" bind:value={title} placeholder="title" />
		<Textarea
			id="editor"
			rows="8"
			class="mb-4"
			placeholder="Write a comment"
			bind:value={body}
		>
			<Toolbar color="dark" slot="header" embedded>
				<input type="file" accept="image/*" bind:files />
			</Toolbar>
			<hr />

			<!-- <img { src } alt="" style="height: 30%; width:30%"> -->
		</Textarea>
		<svelte:fragment slot="footer">
			<Button
				color="purple"
				on:click={async (e) => {
					const description = {
						user: displayName,
						group: "group1",
						date: new Date(),
						title,
						body,
					};

					const response = await fetch("/api/post/upload", {
						method: "POST",
						body: JSON.stringify({ description }),
						headers: {
							"Content-Type": "application/json",
						},
					});

					// Array(displayName, chat, new Date());

					await response.json();
					postting = [
						...postting,
						{	
							user: displayName,
							group: "group1",
							date: new Date(),
							title,
							body,
							
						},
					];
					console.log(files);
					title = "";
					body = "";
					e.preventDefault();
				}}>Publish</Button
			>
			<Button color="alternative">Decline</Button>
		</svelte:fragment>
	</Modal>
</body>

<style>
	body {
		background-color: rgb(237, 237, 250);
		height: 100vh;
		width: 100vw;
	}
	.group {
		margin-top: 30px;
		width: 70%;
		height: 100vh;
		padding-bottom: 20px;
		overflow: scroll;
		border: 1px none #000;
		overflow: auto;
		white-space: nowrap;
		border-right: 1px solid white;
	}
	body {
		width: 100%;
		height: 745px;
		padding: 20px;
		overflow: scroll;
		border: 1px none #000;
	}

	* {
		margin: 0;
		padding: 0;
	}

	.chat_wrap .header {
		font-size: 14px;
		padding: 15px 0;
		background: rgb(132, 132, 216);
		color: white;
		text-align: center;
		font-weight: bold;
	}

	.chat_wrap .chat {
		padding-bottom: 80px;
		margin-top: 1;
	}
	.chat_wrap .chat ul {
		width: 100%;
		list-style: none;
	}
	.chat_wrap .chat ul li {
		width: 100%;
	}
	.chat_wrap .chat ul li.left {
		text-align: left;
	}
	.chat_wrap .chat ul li.right {
		text-align: right;
	}
	.chat_wrap .chat ul li > span.profile {
		border: 1px solid black;
		border-radius: 100%;
		padding: 10px;
		margin: 10px;
	}

	.chat_wrap .chat ul li > div {
		font-size: 13px;
	}

	.chat_wrap .chat ul li > div.message {
		display: inline-block;
		word-break: break-all;
		margin: 5px 20px;
		max-width: 75%;
		border: 1px solid #888;
		padding: 10px;
		border-radius: 5px;
		background-color: #fcfcfc;
		color: #555;
		text-align: left;
	}

	.chat_wrap .input-div {
		position: fixed;
		bottom: 0;
		width: 432px;
		background-color: #fff;
		text-align: center;
		border-top: 1px solid rgb(132, 132, 216);
	}
	.chat_wrap .input-div > textarea {
		width: 100%;
		height: 80px;
		border: none;
		padding: 10px;
	}
</style>
